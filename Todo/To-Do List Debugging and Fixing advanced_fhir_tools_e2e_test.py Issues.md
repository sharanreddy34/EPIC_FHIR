# To-Do List: Debugging and Fixing `advanced_fhir_tools_e2e_test.py` Issues

**Project Root:** `/Users/gabe/ATLAS Palantir/`
**Main Test Script:** `epic-fhir-integration/scripts/advanced_fhir_tools_e2e_test.py`
**README Reference:** `/Users/gabe/ATLAS Palantir/epic-fhir-integration/README.md` (This to-do list can inform a "Development Status" or "Known Issues" section in the README).

---

## I. Great Expectations Integration (`epic_fhir_integration/metrics/great_expectations_validator.py`)

### 1. Issue: Great Expectations Suites Not Found

*   **Symptom:**
    *   Quality metrics files (e.g., `real_patient_test/bronze/quality_metrics.json`) for all tiers (Bronze, Silver, Gold) show 0% quality scores.
    *   Error messages in quality reports: "Expectation suite 'X_expectations' not found" for each resource type.
    *   Logs from `GreatExpectationsValidator` show: "Error: No gx directory was found here!" and fallback to an ephemeral DataContext.
*   **Root Cause Analysis:**
    *   The `GreatExpectationsValidator` (`epic_fhir_integration/metrics/great_expectations_validator.py`) cannot locate or load the pre-defined expectation suite JSON files.
    *   **Primary Cause:** The Great Expectations DataContext is likely not being initialized to the correct directory. `great_expectations init` was run within `epic-fhir-integration/`, creating `epic-fhir-integration/great_expectations/`. However, the validator might be looking for a `great_expectations/` directory at the true project root (`/Users/gabe/ATLAS Palantir/`) or is not correctly resolving the path.
    *   **Secondary Causes:**
        1.  Expectation suite files (e.g., `patient_bronze_expectations.json`) might not be correctly generated by `epic-fhir-integration/scripts/create_gx_expectations.py` into the `epic-fhir-integration/great_expectations/expectations/` directory.
        2.  Path misconfiguration in `GreatExpectationsValidator` when determining `expectation_suite_dir`.
*   **Action Plan:**
    1.  **Standardize GX Directory Location:**
        *   **Decision Point:** Decide if the `great_expectations/` directory should live at the project root (`/Users/gabe/ATLAS Palantir/great_expectations/`) or within the application module (`/Users/gabe/ATLAS Palantir/epic-fhir-integration/great_expectations/`). The latter is common for self-contained applications.
    2.  **Fix DataContext Initialization in `GreatExpectationsValidator`:**
        *   Modify `epic_fhir_integration/metrics/great_expectations_validator.py` to correctly initialize the `DataContext`.
        *   If `epic-fhir-integration/great_expectations/` is the chosen location, ensure `context_root_dir` correctly points there. Consider making this path configurable or reliably derived (e.g., relative to the `epic_fhir_integration` module path).
        *   **Code Change:** Review `GreatExpectationsValidator.__init__` and how `ge.data_context.DataContext(context_root_dir=...)` is called. The `project_dir` logic needs to correctly point to where `great_expectations init` was run.
    3.  **Verify Suite Generation and Path:**
        *   Run `python epic-fhir-integration/scripts/create_gx_expectations.py`.
        *   Confirm that `.json` files for each resource type and tier are created in the chosen `great_expectations/expectations/` directory (e.g., `epic-fhir-integration/great_expectations/expectations/`).
        *   In `GreatExpectationsValidator._load_expectation_suites`, add verbose logging to print the `self.expectation_suite_dir` being used and the suite files it attempts to load.
    4.  **Test Thoroughly:** Rerun `advanced_fhir_tools_e2e_test.py` and verify that quality scores are now generated based on actual expectations.

---

## II. FHIRPath Evaluation Issues (`epic_fhir_integration/utils/fhirpath_adapter.py`)

### 2. Issue: Patient Name Extraction for Gold Tier Narratives is "Unknown"

*   **Symptom:**
    *   The `Patient.text.div` narrative in `real_patient_test/gold/resources.json` shows `<p>Patient: Unknown, ...</p>`.
    *   `real_patient_test/results/fhirpath_results.json` shows `patient_name: null`.
*   **Root Cause Analysis:**
    *   The FHIRPath expression `name.where(use='official').given.first()` (used in `advanced_fhir_tools_e2e_test.py` -> `_generate_narrative`) is not being evaluated correctly by `FHIRPathAdapter.extract_first`.
    *   This could be due to `fhirpathpy` not being used (falling back to `MockFHIRPath`) or an issue in how `fhirpathpy` handles this specific path with the provided data structure if it *is* being used. The `MockFHIRPath` is too basic for this.
*   **Action Plan:**
    1.  **Ensure `fhirpathpy` is Used:**
        *   In `epic_fhir_integration/utils/fhirpath_adapter.py`, examine the logs around `FHIRPathEngine` instantiation. If "Using MockFHIRPath due to import error" appears, resolve the `fhirpathpy` import/installation issue.
        *   Verify `fhirpathpy` is in `requirements.txt` and correctly installed (`pip list | grep fhirpathpy`).
    2.  **Debug FHIRPath Evaluation:**
        *   In `FHIRPathAdapter.evaluate`, log the exact resource snippet, the path expression, and the result from `fhirpathpy.evaluate`.
        *   Specifically test `name.where(use='official').given.first()` against the sample patient data.
    3.  **Verify Sample Data for Path:** Double-check the structure of `Patient.name` in the sample data (`advanced_fhir_tools_e2e_test.py` -> `create_sample_resources`) to ensure it's compatible with the path.

### 3. Issue: Other FHIRPath Evaluations in `test_fhirpath` Return `None`

*   **Symptom:** `real_patient_test/results/fhirpath_results.json` shows `null` for `gender`, `birth_date`, `address`, `telecom`, and `observation_values`.
*   **Root Cause Analysis:**
    *   Same as above: likely an issue with `FHIRPathAdapter`'s use of `fhirpathpy` or an over-reliance on the simplistic `MockFHIRPath` if `fhirpathpy` fails to load. Simple paths like `gender` or `birthDate` should be straightforward for `fhirpathpy`.
*   **Action Plan:**
    1.  **Prioritize `fhirpathpy` (Same as 2.1):** This is the most critical step. The script should use the real `fhirpathpy` library.
    2.  **Detailed Logging in `FHIRPathAdapter` (Same as 2.2):** Log evaluation of these specific paths: `gender`, `birthDate`, `address.line.first()`, `telecom.where(system='phone').value.first()`, `valueQuantity.value`.
    3.  **Standalone Path Tests:** Create a minimal script to test these paths with `fhirpathpy` directly against the sample JSON to rule out issues with the library itself for these structures.
        ```python
        # Minimal test snippet
        import json
        from fhirpathpy import evaluate
        # Load your sample patient/observation JSON here
        # patient_resource = json.loads(...)
        # print(evaluate(patient_resource, 'gender'))
        # print(evaluate(patient_resource, 'birthDate'))
        ```

---

## III. Pathling Service Integration (`epic_fhir_integration/analytics/pathling_service.py`)

### 4. Issue: Pathling Service Falls Back to Mock Mode Due to Docker Issues

*   **Symptom:** Logs show:
    *   `unable to get image 'aehrc/pathling:6.3.0': Cannot connect to the Docker daemon...`
    *   `Failed to start Pathling server: Command '['docker-compose', 'up', '-d']' returned non-zero exit status 1.`
    *   `Falling back to mock mode due to Docker error`
*   **Root Cause Analysis:**
    *   The Docker daemon is not running or is inaccessible to the script's execution environment.
    *   `docker-compose` cannot interact with the Docker daemon.
*   **Action Plan:**
    1.  **Local Docker Environment Check:**
        *   **User Action:** Ensure Docker Desktop (or Docker Engine) is running.
        *   **User Action:** Verify Docker daemon connectivity by running `docker ps` in the terminal.
        *   **User Action:** Check user permissions for accessing the Docker socket/daemon.
    2.  **`docker-compose.yml` and Image:**
        *   The script auto-generates `docker-compose.yml` at the project root (`/Users/gabe/ATLAS Palantir/docker-compose.yml`).
        *   Verify the image `aehrc/pathling:6.3.0` is valid and pullable.
        *   Ensure the volume mount path for data (`pathling_data/` in the project root) is correct and writable.
    3.  **Manual `docker-compose` Test:**
        *   Navigate to `/Users/gabe/ATLAS Palantir/` in the terminal.
        *   Manually run `docker-compose up -d` (after the script has attempted to create the YAML or using a manually prepared one). Observe any specific errors.
    4.  **Enhance Script (Optional):** Consider adding more detailed error capturing from the `docker-compose` subprocess call in `PathlingService.start_server` to provide more direct feedback on Docker issues.
    5.  **Documentation:** Update `epic-fhir-integration/README.md` to clearly state Docker as a prerequisite for full Pathling functionality, including setup and troubleshooting tips for Docker daemon issues.

---

## IV. General Script and Configuration Enhancements

### 5. Review Placeholder/Mock Logic

*   **Symptom:** Several components (Pathling, FHIRPath adapter) have fallbacks to mock implementations.
*   **Root Cause Analysis:** These fallbacks are good for resilience but can hide underlying setup issues if not carefully monitored.
*   **Action Plan:**
    1.  **Clear Logging for Fallbacks:** Ensure that whenever a mock implementation is used as a fallback, it logs a very prominent WARNING message, clearly stating *why* the fallback is happening (e.g., "WARNING: PathlingService falling back to mock mode because Docker daemon is unavailable.").
    2.  **Configuration Option for Strict Mode:** Consider adding a command-line flag or environment variable to `advanced_fhir_tools_e2e_test.py` like `--strict-mode` which, if set, would cause the script to fail immediately if any component falls back to a mock implementation, rather than continuing silently. This would be useful for CI/CD or ensuring production-like tests.

### 6. Update Project README

*   **Action Plan:**
    1.  Add a "Current Status" or "Known Issues & To-Do" section to `epic-fhir-integration/README.md`.
    2.  Reference this to-do list file or summarize its key points there.
    3.  Include prerequisites like a running Docker daemon and correctly configured Great Expectations setup.

--- 